<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibility Control System</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .status-alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .status-alert.success {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .status-alert.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
        }
        
        .status-alert.warning {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid var(--warning);
            color: var(--warning);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .video-section, .control-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .video-container {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        #video {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .gesture-feedback {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
            animation: pulse 1.5s infinite;
        }
        
        .gesture-feedback.active {
            display: block;
            color: var(--success);
        }
        
        .gesture-feedback.inactive {
            display: block;
            color: var(--accent);
        }
        
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .status-card.active {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid var(--success);
        }
        
        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            background: linear-gradient(45deg, var(--secondary), #2980b9);
            border: none;
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .control-btn.emergency {
            background: linear-gradient(45deg, var(--accent), #c0392b);
        }
        
        .control-btn.success {
            background: linear-gradient(45deg, var(--success), #229954);
        }
        
        .gesture-guide {
            margin-top: 30px;
        }
        
        .gesture-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .gesture-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--secondary);
            transition: transform 0.2s;
        }
        
        .gesture-card:hover {
            transform: translateY(-3px);
        }
        
        .gesture-card h3 {
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.8;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--accent);
        }
        
        .status-indicator.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        .calibration-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .calibration-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .calibration-btn {
            background: linear-gradient(45deg, var(--warning), #e67e22);
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .calibration-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .calibration-btn.active {
            background: linear-gradient(45deg, var(--success), #27ae60);
            animation: pulse 1s infinite;
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            border-radius: 4px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary);
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary);
            cursor: pointer;
        }
        
        .visual-feedback {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 10px;
        }
        
        .feedback-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--accent);
            transition: all 0.3s;
        }
        
        .feedback-dot.active {
            background: var(--success);
            transform: scale(1.3);
            box-shadow: 0 0 10px var(--success);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: rgba(44, 62, 80, 0.95);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--light);
            font-size: 24px;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        @keyframes highlight {
            0% { background-color: rgba(39, 174, 96, 0.2); }
            100% { background-color: rgba(255, 255, 255, 0.05); }
        }
        
        .highlight {
            animation: highlight 1s ease;
        }
        
        .emoji {
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñêÔ∏è Accessibility Control System</h1>
            <p class="subtitle">üëã Hands-free computer control through gesture recognition</p>
            
            <div class="status-alert" id="status-alert"></div>
        </header>
        
        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <img id="video" src="/video_feed" alt="Live Camera Feed" onerror="this.style.display='none'">
                    <div class="gesture-feedback" id="gesture-feedback"></div>
                </div>
                
                <div class="status-panel">
                    <div class="status-card" id="system-status-card">
                        <h3>‚öôÔ∏è System Status</h3>
                        <div class="status-value" id="system-status">‚èπÔ∏è Stopped</div>
                    </div>
                    <div class="status-card" id="gesture-status-card">
                        <h3>üëã Current Gesture</h3>
                        <div class="status-value" id="current-gesture">‚ùå None</div>
                    </div>
                    <div class="status-card" id="mode-status-card">
                        <h3>üñ±Ô∏è Control Mode</h3>
                        <div class="status-value" id="control-mode">üëÜ Gesture</div>
                    </div>
                    <div class="status-card" id="voice-status-card">
                        <h3>üîä Voice Feedback</h3>
                        <div class="status-value" id="voice-status">üîá Off</div>
                    </div>
                </div>
                
                <div class="connection-status">
                    <div class="status-indicator" id="connection-indicator"></div>
                    <span id="connection-text">üì° Connecting...</span>
                </div>
                
                <div class="control-grid">
                    <button class="control-btn success" id="start-btn" onclick="startController()">‚ñ∂Ô∏è Start Controller</button>
                    <button class="control-btn" id="stop-btn" onclick="stopController()">‚èπÔ∏è Stop Controller</button>
                    <button class="control-btn" onclick="toggleCursor()">üñ±Ô∏è Toggle Cursor Mode</button>
                    <button class="control-btn" onclick="toggleVoice()">üîä Toggle Voice Feedback</button>
                    <button class="control-btn" onclick="showHelp()">‚ùì Show Help</button>
                    <button class="control-btn emergency" onclick="emergencyStop()">üÜò Emergency Stop</button>
                    <button class="control-btn" onclick="openCalibrationModal()">üéØ Calibrate System</button>
                    <button class="control-btn" onclick="window.location.href='/training'">Open Training Interface</button>
                </div>
                
                <div class="visual-feedback">
                    <div class="feedback-dot" id="feedback-dot-1"></div>
                    <div class="feedback-dot" id="feedback-dot-2"></div>
                    <div class="feedback-dot" id="feedback-dot-3"></div>
                    <div class="feedback-dot" id="feedback-dot-4"></div>
                    <div class="feedback-dot" id="feedback-dot-5"></div>
                </div>
            </div>
            
            <div class="control-section">
                <h2>üìã Gesture Guide</h2>
                <div class="gesture-cards">
                    <div class="gesture-card">
                        <h3>üñ±Ô∏è Cursor Mode</h3>
                        <p>Enable/disable mouse control</p>
                        <small>Hold gesture for 1 second</small>
                    </div>
                    <div class="gesture-card">
                        <h3>üëÜ Click</h3>
                        <p>Left mouse click</p>
                        <small>Only works in cursor mode</small>
                    </div>
                    <div class="gesture-card">
                        <h3>üëâ Right Click</h3>
                        <p>Right mouse click</p>
                        <small>Only works in cursor mode</small>
                    </div>
                    <div class="gesture-card">
                        <h3>üëÜüëÜ Double Click</h3>
                        <p>Double left click</p>
                        <small>Only works in cursor mode</small>
                    </div>
                    <div class="gesture-card">
                        <h3>üëê Drag</h3>
                        <p>Click and drag items</p>
                        <small>Hold to start dragging</small>
                    </div>
                    <div class="gesture-card">
                        <h3>üñêÔ∏è Scroll Up/Down</h3>
                        <p>Scroll page content</p>
                        <small>Works in any mode</small>
                    </div>
                    <div class="gesture-card">
                        <h3>üìã Copy/Paste</h3>
                        <p>Clipboard operations</p>
                        <small>Standard Ctrl+C/V shortcuts</small>
                    </div>
                    <div class="gesture-card">
                        <h3>üéµ Media Controls</h3>
                        <p>Play, pause, volume</p>
                        <small>System media controls</small>
                    </div>
                </div>
                
                <div class="gesture-guide">
                    <h2>üíª System Information</h2>
                    <div class="gesture-cards">
                        <div class="gesture-card">
                            <h3>üß† Model Status</h3>
                            <p id="model-status">‚è≥ Loading...</p>
                        </div>
                        <div class="gesture-card">
                            <h3>üì∑ Camera Status</h3>
                            <p id="camera-status">‚ùå Not connected</p>
                        </div>
                        <div class="gesture-card">
                            <h3>üéØ Confidence Threshold</h3>
                            <p id="confidence-threshold">70%</p>
                        </div>
                        <div class="gesture-card">
                            <h3>üÜò Emergency Stop</h3>
                            <p>Triple click gesture or red button</p>
                        </div>
                    </div>
                </div>
                
                <div class="calibration-section">
                    <h2>üéØ Quick Calibration</h2>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>üéÆ Cursor Sensitivity</span>
                            <span id="sensitivity-value">2.0</span>
                        </div>
                        <input type="range" min="0.5" max="5.0" step="0.1" value="2.0" class="slider" id="sensitivity-slider" onchange="updateSensitivity(this.value)">
                    </div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>‚úÖ Gesture Confidence</span>
                            <span id="confidence-value">70%</span>
                        </div>
                        <input type="range" min="30" max="95" step="5" value="70" class="slider" id="confidence-slider" onchange="updateConfidence(this.value)">
                    </div>
                    
                    <div class="calibration-controls">
                        <button class="calibration-btn" onclick="calibrateGesture('click')">üëÜ Calibrate Click</button>
                        <button class="calibration-btn" onclick="calibrateGesture('scroll_up')">üñêÔ∏è Calibrate Scroll</button>
                        <button class="calibration-btn" onclick="calibrateGesture('cursor_mode')">üñ±Ô∏è Calibrate Cursor</button>
                        <button class="calibration-btn" onclick="resetCalibration()">üîÑ Reset Calibration</button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>¬©Ô∏è Accessibility Control System | üéØ Designed for hands-free computer operation</p>
        </footer>
    </div>

    <!-- Calibration Modal -->
    <div class="modal" id="calibration-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üéØ System Calibration</h2>
                <button class="close-modal" onclick="closeCalibrationModal()">&times;</button>
            </div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>üéÆ Cursor Speed</span>
                    <span id="cursor-speed-value">2.0</span>
                </div>
                <input type="range" min="0.5" max="5.0" step="0.1" value="2.0" class="slider" id="cursor-speed-slider" onchange="updateCursorSpeed(this.value)">
            </div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>üìú Scroll Speed</span>
                    <span id="scroll-speed-value">40</span>
                </div>
                <input type="range" min="10" max="100" step="5" value="40" class="slider" id="scroll-speed-slider" onchange="updateScrollSpeed(this.value)">
            </div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>‚è±Ô∏è Gesture Hold Time</span>
                    <span id="hold-time-value">1.0s</span>
                </div>
                <input type="range" min="0.5" max="3.0" step="0.1" value="1.0" class="slider" id="hold-time-slider" onchange="updateHoldTime(this.value)">
            </div>
            
            <h3>üîß Calibrate Specific Gestures</h3>
            <div class="calibration-controls">
                <button class="calibration-btn" id="calibrate-click" onclick="startGestureCalibration('click')">üëÜ Calibrate Click</button>
                <button class="calibration-btn" id="calibrate-scroll" onclick="startGestureCalibration('scroll_up')">üñêÔ∏è Calibrate Scroll</button>
                <button class="calibration-btn" id="calibrate-cursor" onclick="startGestureCalibration('cursor_mode')">üñ±Ô∏è Calibrate Cursor Mode</button>
            </div>
            
            <div id="calibration-instructions" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; display: none;">
                <h4>üìã Calibration Instructions</h4>
                <p id="instruction-text"></p>
                <div class="visual-feedback" style="justify-content: start;">
                    <div class="feedback-dot" id="calibration-dot-1"></div>
                    <div class="feedback-dot" id="calibration-dot-2"></div>
                    <div class="feedback-dot" id="calibration-dot-3"></div>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="control-btn success" onclick="saveCalibration()">üíæ Save Settings</button>
                <button class="control-btn" onclick="closeCalibrationModal()">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let systemRunning = false;
        let currentSettings = {};
        let calibrationActive = false;
        let currentCalibrationGesture = null;
        let calibrationStep = 0;
        
        // Show status alert
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('status-alert');
            alert.textContent = message;
            alert.className = `status-alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connection-indicator');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = '‚úÖ Connected';
                isConnected = true;
            } else {
                indicator.classList.remove('connected');
                text.textContent = '‚ùå Disconnected';
                isConnected = false;
            }
        }
        
        // Update UI based on system status
        function updateUI(status) {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const systemStatus = document.getElementById('system-status');
            const systemStatusCard = document.getElementById('system-status-card');
            const gestureStatusCard = document.getElementById('gesture-status-card');
            const modeStatusCard = document.getElementById('mode-status-card');
            const voiceStatusCard = document.getElementById('voice-status-card');
            
            if (status.running) {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                systemStatus.textContent = '‚ñ∂Ô∏è Running';
                systemStatus.style.color = 'var(--success)';
                systemStatusCard.classList.add('active');
                systemRunning = true;
            } else {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                systemStatus.textContent = '‚èπÔ∏è Stopped';
                systemStatus.style.color = 'var(--accent)';
                systemStatusCard.classList.remove('active');
                systemRunning = false;
            }
            
            // Update other status fields
            const currentGesture = status.current_gesture || 'none';
            document.getElementById('current-gesture').textContent = currentGesture !== 'none' ? 'üëÜ ' + currentGesture : '‚ùå None';
            
            const controlMode = status.cursor_mode ? 'üñ±Ô∏è Cursor' : 'üëÜ Gesture';
            document.getElementById('control-mode').textContent = controlMode;
            
            const voiceStatus = status.voice_enabled ? 'üîä On' : 'üîá Off';
            document.getElementById('voice-status').textContent = voiceStatus;
            
            // Update card highlights based on state
            gestureStatusCard.classList.toggle('active', currentGesture !== 'none');
            modeStatusCard.classList.toggle('active', status.cursor_mode);
            voiceStatusCard.classList.toggle('active', status.voice_enabled);
            
            // Show visual feedback for gestures
            showGestureFeedback(currentGesture);
            
            // Update system info
            if (status.settings) {
                currentSettings = status.settings;
                document.getElementById('confidence-threshold').textContent = 
                    Math.round(status.settings.gesture_confidence_threshold * 100) + '%';
                document.getElementById('confidence-value').textContent = 
                    Math.round(status.settings.gesture_confidence_threshold * 100) + '%';
                document.getElementById('confidence-slider').value = 
                    Math.round(status.settings.gesture_confidence_threshold * 100);
                
                document.getElementById('sensitivity-value').textContent = 
                    status.settings.cursor_speed.toFixed(1);
                document.getElementById('sensitivity-slider').value = 
                    status.settings.cursor_speed;
                
                document.getElementById('cursor-speed-value').textContent = 
                    status.settings.cursor_speed.toFixed(1);
                document.getElementById('cursor-speed-slider').value = 
                    status.settings.cursor_speed;
                
                document.getElementById('scroll-speed-value').textContent = 
                    status.settings.scroll_speed;
                document.getElementById('scroll-speed-slider').value = 
                    status.settings.scroll_speed;
                
                document.getElementById('hold-time-value').textContent = 
                    status.settings.gesture_hold_time.toFixed(1) + 's';
                document.getElementById('hold-time-slider').value = 
                    status.settings.gesture_hold_time;
            }
        }
        
        // Show visual feedback for gestures
        function showGestureFeedback(gesture) {
            const feedback = document.getElementById('gesture-feedback');
            
            if (gesture !== 'none') {
                feedback.textContent = `üëÜ ${gesture.replace('_', ' ')}`;
                feedback.className = 'gesture-feedback active';
                
                // Animate feedback dots
                animateFeedbackDots();
                
                setTimeout(() => {
                    feedback.className = 'gesture-feedback';
                }, 2000);
            }
        }
        
        // Animate feedback dots
        function animateFeedbackDots() {
            const dots = [
                document.getElementById('feedback-dot-1'),
                document.getElementById('feedback-dot-2'),
                document.getElementById('feedback-dot-3'),
                document.getElementById('feedback-dot-4'),
                document.getElementById('feedback-dot-5')
            ];
            
            dots.forEach((dot, index) => {
                setTimeout(() => {
                    dot.classList.add('active');
                    setTimeout(() => {
                        dot.classList.remove('active');
                    }, 300);
                }, index * 100);
            });
        }
        
        // API call wrapper with error handling
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'API call failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showAlert(error.message, 'error');
                updateConnectionStatus(false);
                throw error;
            }
        }
        
        // Update status information
        async function updateStatus() {
            try {
                const data = await apiCall('/status');
                updateConnectionStatus(true);
                updateUI(data);
                
            } catch (error) {
                updateConnectionStatus(false);
                // Set default status when disconnected
                updateUI({
                    running: false,
                    gesture: 'none',
                    cursor_mode: false,
                    voice_enabled: false
                });
            }
        }
        
        // Control functions
        async function startController() {
            try {
                const data = await apiCall('/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                showAlert(data.message, data.status === 'success' ? 'success' : 'warning');
                await updateStatus();
            } catch (error) {
                // Error already handled in apiCall
            }
        }
        
        async function stopController() {
            try {
                const data = await apiCall('/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                showAlert(data.message, 'success');
                await updateStatus();
            } catch (error) {
                // Error already handled in apiCall
            }
        }
        
        async function toggleCursor() {
            try {
                const data = await apiCall('/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'toggle_cursor' })
                });
                showAlert(data.message, 'success');
                await updateStatus();
            } catch (error) {
                // Error already handled in apiCall
            }
        }
        
        async function toggleVoice() {
            try {
                const data = await apiCall('/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'toggle_voice' })
                });
                showAlert(data.message, 'success');
                await updateStatus();
            } catch (error) {
                // Error already handled in apiCall
            }
        }
        
        async function emergencyStop() {
            try {
                const data = await apiCall('/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'emergency_stop' })
                });
                showAlert(data.message, 'warning');
                await updateStatus();
            } catch (error) {
                // Error already handled in apiCall
            }
        }
        
        async function showHelp() {
            try {
                const data = await apiCall('/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: 'help' })
                });
                showAlert(data.message, 'success');
            } catch (error) {
                // Error already handled in apiCall
            }
        }
        
        // Calibration functions
        function openCalibrationModal() {
            document.getElementById('calibration-modal').style.display = 'flex';
        }
        
        function closeCalibrationModal() {
            document.getElementById('calibration-modal').style.display = 'none';
            stopCalibration();
        }
        
        async function updateSensitivity(value) {
            document.getElementById('sensitivity-value').textContent = parseFloat(value).toFixed(1);
            await updateSetting('cursor_speed', parseFloat(value));
        }
        
        async function updateConfidence(value) {
            const confidence = parseInt(value) / 100;
            document.getElementById('confidence-value').textContent = value + '%';
            await updateSetting('gesture_confidence_threshold', confidence);
        }
        
        async function updateCursorSpeed(value) {
            document.getElementById('cursor-speed-value').textContent = parseFloat(value).toFixed(1);
            await updateSetting('cursor_speed', parseFloat(value));
        }
        
        async function updateScrollSpeed(value) {
            document.getElementById('scroll-speed-value').textContent = value;
            await updateSetting('scroll_speed', parseInt(value));
        }
        
        async function updateHoldTime(value) {
            document.getElementById('hold-time-value').textContent = parseFloat(value).toFixed(1) + 's';
            await updateSetting('gesture_hold_time', parseFloat(value));
        }
        
        async function updateSetting(key, value) {
            try {
                const settings = {...currentSettings, [key]: value};
                const data = await apiCall('/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (data.status === 'success') {
                    currentSettings[key] = value;
                }
            } catch (error) {
                console.error('Error updating setting:', error);
            }
        }
        
        async function saveCalibration() {
            try {
                const data = await apiCall('/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentSettings)
                });
                
                showAlert('‚úÖ Calibration settings saved', 'success');
                closeCalibrationModal();
            } catch (error) {
                console.error('Error saving calibration:', error);
            }
        }
        
        function startGestureCalibration(gesture) {
            currentCalibrationGesture = gesture;
            calibrationStep = 0;
            calibrationActive = true;
            
            // Update UI
            document.getElementById('calibration-instructions').style.display = 'block';
            document.getElementById('instruction-text').textContent = getCalibrationInstructions(gesture, calibrationStep);
            
            // Highlight active button
            document.querySelectorAll('.calibration-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`calibrate-${gesture.split('_')[0]}`).classList.add('active');
            
            // Start calibration process
            performCalibrationStep();
        }
        
        function getCalibrationInstructions(gesture, step) {
            const instructions = {
                'click': [
                    'üëÜ Perform a clicking gesture now',
                    '‚è±Ô∏è Hold the gesture for 2 seconds',
                    '‚úÖ Release the gesture to complete calibration'
                ],
                'scroll_up': [
                    'üñêÔ∏è Perform a scroll up gesture now',
                    '‚è±Ô∏è Hold the gesture for 2 seconds',
                    '‚úÖ Release the gesture to complete calibration'
                ],
                'cursor_mode': [
                    'üñ±Ô∏è Perform the cursor mode activation gesture',
                    '‚è±Ô∏è Hold the gesture for 2 seconds',
                    '‚úÖ Release the gesture to complete calibration'
                ]
            };
            
            return instructions[gesture][step] || 'üéâ Calibration complete!';
        }
        
        function performCalibrationStep() {
            if (!calibrationActive) return;
            
            const dots = [
                document.getElementById('calibration-dot-1'),
                document.getElementById('calibration-dot-2'),
                document.getElementById('calibration-dot-3')
            ];
            
            // Highlight current step
            dots.forEach((dot, index) => {
                if (index === calibrationStep) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
            
            // Move to next step after delay
            if (calibrationStep < 2) {
                setTimeout(() => {
                    calibrationStep++;
                    document.getElementById('instruction-text').textContent = 
                        getCalibrationInstructions(currentCalibrationGesture, calibrationStep);
                    performCalibrationStep();
                }, 2000);
            } else {
                setTimeout(() => {
                    stopCalibration();
                    showAlert(`üéâ ${currentCalibrationGesture.replace('_', ' ')} calibration complete!`, 'success');
                }, 1000);
            }
        }
        
        function stopCalibration() {
            calibrationActive = false;
            currentCalibrationGesture = null;
            calibrationStep = 0;
            
            // Reset UI
            document.getElementById('calibration-instructions').style.display = 'none';
            document.querySelectorAll('.calibration-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.feedback-dot').forEach(dot => {
                dot.classList.remove('active');
            });
        }
        
        async function calibrateGesture(gesture) {
            try {
                const data = await apiCall('/calibrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gesture: gesture })
                });
                showAlert(`üëÜ ${gesture.replace('_', ' ')} calibration started`, 'success');
                
                // Show visual feedback
                startGestureCalibration(gesture);
            } catch (error) {
                console.error('Error calibrating gesture:', error);
                showAlert('‚ùå Calibration failed. Please try again.', 'error');
            }
        }
        
        async function resetCalibration() {
            try {
                const data = await apiCall('/calibrate_reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                showAlert('üîÑ Calibration reset to default values', 'success');
            } catch (error) {
                console.error('Error resetting calibration:', error);
                showAlert('‚ùå Failed to reset calibration', 'error');
            }
        }
        
        // Initialize and start status updates
        document.addEventListener('DOMContentLoaded', function() {
            // Initial status check
            updateStatus();
            
            // Regular status updates
            setInterval(updateStatus, 2000);
            
            // Check video feed status
            const video = document.getElementById('video');
            video.onload = () => {
                document.getElementById('camera-status').textContent = '‚úÖ Connected';
            };
            video.onerror = () => {
                document.getElementById('camera-status').textContent = '‚ùå Not available';
            };
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === ' ') {
                e.preventDefault();
                emergencyStop();
            }
        });
    </script>
</body>
</html>